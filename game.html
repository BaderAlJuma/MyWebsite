<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="style.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    </head>
    <body>
        <div class="table-responsive-sm"  >
            <table class='table' style='border: 1px solid black'>
                <th style='padding: 15px'>Weather: <span id='weather'></span></th>
                <th style='text-align: center;'>Time of Day: <span id="timeofday"></span><div>Time: <span id="time"></span></div></th>
                <th style='text-align: right;'>Season: <span id="season"></span></th>
            </table>
          </div>
          <div class="row">
            <div class="col">
                <ul>
                <li>Available Men: <span id='men'></span></li>
                <li>Food: <span id='food'></span></li>
           </ul>
        </div>
            <div class="col">
            <ul>
                <li>Workers: <span id='workers'></span></li>
                <li>Farmers: <span id='farmers'></span></li>
                <li>Soldiers In Training: <span id='trainees'></span></li>
                <li>Soldiers (I): <span id='soldiers'></span></li>
            </ul>
            </div>
            <div class="col">
                <ul id="buildings">
    
                    
                </ul>
                </div>
          </div>
          <hr>
          <div class="row">
            <div class="col">
                <ul>
                
           </ul>
        </div>
            <div class="col">
            <ul>
               
            </ul>
            </div>
            <div class="col">
                <ul id="buildingsTBC">
                    <progress id="bar" style="width:40%;" value=0 max="50"> 32% </progress>
                    
                    
                </ul>
                </div>
          </div>
          
       
       <div class="card">
        <div class="card-header font-weight-bold">Event Log</div>
        <div class="card-body" id="info"></div>
      </div>
    </body>
    <script>
        var workerCount = 0;
        var foodCount = 0;
        var farmerCount = 0;        
        var menCount = 10;
        var soldierCount =0;
        var traineeCount =0;

        var trainTime = 0;

        var paused = false;

        var time2 = setInterval(theGameLoop, 1000);
        var time = setInterval(updateTag, 1000/60);

        eventsArray= [];
        function tagText(id, inner){
            document.getElementById(id).innerHTML = inner;
        }

        window.addEventListener("keypress", resolveKey);
        //maps each key to a corresponding function.
        function resolveKey() {
            switch (event.key) {
                case 'w': hireMan("worker"); break;
                case 'W': removeMan("worker"); break;
                case 'f': hireMan("farmer"); break;
                case 'F': removeMan("farmer"); break;
                case 'p': pauseToggle(); break;
                case 's': makeSoldier(); break;
                case '7': makeBuilding("mill", true); break;
                default: ;
            }
        }

        var ticks = 0;
        var sixtyTicks;
        function updateTag(){
            //check for events that end on the current tick and execute the 
            //respective function.
            
            for(i in eventsArray){
                //console.log(eventsArray[i]);
                if (ticks - eventsArray[i].eventTime >= 0) {
                    console.log(eventsArray[i]);
                    eventsArray[i].func();
                    if ((eventsArray[i].recurring > 0)){
                        eventsArray[i].eventTime = (eventsArray[i].eventTime)+eventsArray[i].multiplier;
                        eventsArray[i].recurring--;
                        
                    }
                    else {
                        eventsArray.splice(i, 1);
                    }
                }
            }
            //reset bar
            
            
            

            //for updating all HTML tags.
            tagText("workers", workerCount);
            tagText("food", foodCount);
            tagText("farmers", farmerCount);
            tagText("men", menCount);
            tagText("soldiers", soldierCount);
            tagText("trainees", traineeCount);
            tagText("season", "Autumn");
            tagText("info", "Placeholder");
            tagText("time", sixtyTicks);
            document.getElementById("bar").value= progress;

            sixtyTicks = Math.trunc(ticks/60);
            ticks++;
        }
        /*class TimedEvent{
            constructor(timeInSeconds, func){
                this.timeInTicks = timeInSeconds*60;
                this.func = func;
                this.eventTime = ticks + this.timeInTicks;
                
            }
        }*/
        function hey(){
            "hey";
        }
        //for creating timed events that execute a function after a certain time
        function timePlus(timeInSeconds, func, recurring=0){
                timeInTicks = timeInSeconds*60;
                eventTime = ticks + timeInTicks;
                multiplier = timeInTicks;
                let timedEvent = {
                    eventTime,
                    func,
                    recurring,
                    multiplier
                }
                eventsArray.push(timedEvent);
        }
        
        //variable for max value of progress bar with a funcion that activates the progress bar animation
        currentProgress = 10;
        progress = 0;
        document.getElementById("bar").max = currentProgress;
        function activateBar(){   
            if(progress < currentProgress){
                progress++;
                
            } 
            else{
                progress=0;
            }
            
        }

        //pauses the game and displays an alert box
        function pauseToggle(){
                paused = true; 
                clearInterval(time);
                alert('Game Paused');
                paused = false;
                time = setInterval(updateTag, 1000/60);
        }
        //adds text to the buildings section (first column from the right)
        buildingInProgress = false;
        function makeBuilding(name, tbc=false){
            const para = document.createElement("li");
            para.id="b";
            const node = document.createTextNode(name);
            para.appendChild(node);
            
            if(!tbc){
                element = document.getElementById("buildings");
                element.appendChild(para);
            }
            else if(!buildingInProgress){
                buildingInProgress = true;
                if(name === "mill"){
                    timePlus(1, activateBar, 10);
                    timePlus(10, () => { 
                        buildingInProgress = false;
                        makeBuilding("mill");
                        para.remove();
                        
                    })
                }
                element = document.getElementById("buildingsTBC");  
                element.appendChild(para);
            }
        }
        class Men{
            constructor(occupation){
                var alive = true;
                var healthy = true;
                
            }

        }
        function makeSoldier(){
            if (menCount > 0 && traineeCount == 0){
                traineeCount++;
                menCount--;
                trainStart();
            }
        }
        function hireMan(occupation){
            if (menCount > 0){
            switch(occupation){
                case "worker": workerCount++; break;
                case "farmer": farmerCount++; break;
                case "worker": workerCount++; break;
                default: ;
            }
            menCount--;
            }
        }
        //function for removing men; adding them to "available men"
        function removeMan(occupation){
            if(occupation ==="farmer" && farmerCount > 0){
                farmerCount--;
                menCount++;
            }
            else if(occupation ==="worker" && workerCount > 0){
                workerCount--;
                menCount++;
            }
            
            
        }

        function produceFood(){
            foodCount = foodCount + farmerCount;
        }
        function theGameLoop(){
            var currentTime = 0;
            currentTime++;
            if (currentTime < 20) {
                tagText("timeofday", "Morning");
                produceFood();
            }
            else if (currentTime >= 20 && currentTime < 30) {
                tagText("timeofday", "Afternoon");
                consumeFood();
            }
            else if (currentTime >= 30 && currentTime < 50) {
                tagText("timeofday", "Evening");
            }
            else if (currentTime >= 50 && currentTime < 70) {
                tagText("timeofday", "Midnight");
            }
            else {
                currentTime = 0;
            }
        }
        //subtract food based on all active men
        function consumeFood(){
            var totalMen = workerCount + farmerCount + menCount + soldierCount;
            foodCount = foodCount - totalMen*2;
            if (foodCount < 0){
                foodCount = 0;
            }
        }
    </script>
    <hr>
        <div class="container pt-3 pl-5 pr-5 ">
            <div>Instructions: </div>
            <div>w = assign worker, f = assign farmer, p = pause game</div>
            <div>Press "Shift" and the respective worker button to remove a man from his post.</div>
            <div style="color: red;">NOTE!! THIS GAME MUST BE PLAYED WITH A KEYBOARD. 
                THIS GAME IS ALSO A WORK IN PROGRESS.</div>
        </div>
</html>